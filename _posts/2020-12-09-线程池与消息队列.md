---
layout: post
title: 线程池与消息队列
categories: [Java]
description: 
keywords: 
---


* content
{:toc}


## 用线程池ExecutorService异步处理

我理解`ExecutorService`其实也是内部使用了队列(如`LinkedBlockingQueue`), 所以从设计上, 其实和使用中间价的消息队列是差不多一致的. 只是这里应用服务器既充当生产者又充当消费者, 也是消息队列中间价的实现者. 这种应该适合非分布式的架构, 比如简单的只有一台服务器. 

## 使用消息队列

消息队列(指activeMQ, rabbitMQ, kafaKa, Redis等)因为一般都是中间件, 部署在其他机器, 需要一定的网络消耗. 
本着解耦的目的, 使用后者更合理, 因为应用服务器一般内存也不会太多, 队列长度不易太长. 让应用服务器只处理逻辑比较合理. 适合分布式架构. 

## 比较

1. 两者内部都使用了队列, 如阻塞队列, 优先级队列
2. 使用线程池时应用服务器既充当生产者又充当消费者, 也是消息队列中间件的实现者, 使用消息队列时中间件, 生产者, 消费者可以部署在不同的应用机器上(当然也可以部署在一台服务器上但很少有人这么用)
3. 出于第 2 点线程池更适合非分布式的系统, 但在分布式架构下消息队列明显是更优项
4. 使用消息队列会带来额外的网络开销
5. 消息队列的耦合性更低, 可扩展性更好,适用于弱一致性的场景, 如对log日志的解耦
6. 消息队列自动实现消息的持久化, 中间已经实现了大量功能, 如消息转发, 消息拒绝, 消息重试, 以及对消息的一些监控, 例如消息的消费状态, 消息的消费速率, 消息内容查询等, 使用线程池如果需要很多功能还要自己去实现, 例如想要知道执行状态还需要打印队列数量, 计算消息消费速度
7. 在不同系统间的服务调用(调用协议也可能不一致)线程池很难实现或开销很大, 这时候消息队列可以屏蔽不同机器或不同协议的问题
8. 使用消息队列会提升系统的复杂度, 网络抖动怎么办? 最大队列长度怎么设置? 超时时间又设置多少? Qos又设置为多少? 消费者多少个比较合适? Channel cache size又该设置为多少? 业务线可能都是用同一个Mq, 你占资源太多, 或者设计不当可能会导致整个Mq故障.

MQ 可以更加有扩展性, 支持的场景更多, 而且支持消息自动的持久化, 建议你看看 RabbitMQ 和 AMQP 协议, JMS 可以学但是没 AMQP 更加通用, redis 的MQ 还是不要用了, 那只是一个附带的功能, kafka 是大数据领域的不适合做核心业务功能, 只适合数据统计类应用的发送数据, 因为他不确保消息100%不丢失, 如此大的数据量丢一条无所谓的, 不会对统计结果造成影响, 但速度和吞吐量高很多

线程池就不一样了, 目前执行状态你无法知道, msg的消费率是多少都不知道, 消息转发啊, 消息拒绝啊, 都的自己实现, 而且是单机版的, 我目前用他来做一级转发, 就是用他来将 event 异步发送出去, 而不是让他异步做一些很繁重的工作, 举例: 
注册用户service方法, 当事务结束后, 发送 RegisterUserEvent, 这个发送就是用java线程池(如spring的), 然后 RegisterUserListener 监听到了这个 event 就发送 msg 到 Rabbit MQ, 之后对注册用户这个Topic感兴趣的应用都可以订阅, 比如送积分的服务, 送优惠券的服务, 开辟云盘空间的服务等等

尽量用ExecuteService, 如果不是涉及到: 

1. 跨服务业务: 比如订单, 支付
2. 业务去耦合: 比如有些情况上级业务不用知道下级执行是否成功, 比如 log 日志等